<?php
/**
 * @file
 * Description…
 */

// =============================================================================
// Error reporting displayed on the screen
ini_set('error_reporting', E_ALL);
ini_set('display_errors', 'On');



/**
 * Implements hook_init().
 */
function casa_core_init() {
  // dpm('Call: casa_core_init');

  libraries_load('toastr');
  // Try to load the library and check if that worked.
  if (!(($library = libraries_load('toastr')) && !empty($library['loaded']))) {
    drupal_set_message(t('Library ‘Toastr’ not loaded.'), 'error', FALSE);
  }

  drupal_add_library('system', 'ui.dialog', TRUE);
  // Check that the library has been loaded…
}





// =============================================================================
/**
 * Implements hook_block_info().
 */
function casa_core_block_info() {
  $blocks = array();

  $blocks['signup_login'] = array(
    'info' => t('Sign up or log in'),
    'cache' => DRUPAL_CACHE_GLOBAL,
    // 'cache' => DRUPAL_NO_CACHE,
  );

  return $blocks;
}





// =============================================================================
/**
 * Implements hook_block_view().
 */
function casa_core_block_view($delta = '') {
  $block = array();

  // set_error_handler("exception_error_handler");

  switch ($delta) {
    case 'signup_login':
      $block['subject'] = t('Sign up or log in');
      $block['content'] = signup_login_block_content();
      break;
  }

  return $block;
}


function signup_login_block_content() {
  $content = array();
  $content['cols-wrapper'] = array(
    '#prefix' => '<div class="cols-2">',
    '#suffix' => '</div>',
    '#tree' => TRUE,
  );
  $content['cols-wrapper']['col-1'] = array(
    '#prefix' => '<div class="col-1-2">',
    '#suffix' => '</div>',
    '#tree' => TRUE,
    '#weight' => "1",
  );
  $content['cols-wrapper']['col-2'] = array(
    '#prefix' => '<div class="col-1-2">',
    '#suffix' => '</div>',
    '#tree' => TRUE,
  );

  if (!user_is_logged_in()) {
    $content['cols-wrapper']['col-1']['heading'] = array(
      '#markup' => '<h3>Sign up</h3>',
      '#weight' => -1);
    $content['cols-wrapper']['col-1']['login'] = drupal_get_form('user_login');
    $content['cols-wrapper']['col-2']['heading'] = array(
      '#markup' => '<h3>Log in</h3>',
      '#weight' => -1);
    $content['cols-wrapper']['col-2']['register'] = drupal_get_form('user_register_form');
  }
  else {
    global $user;
    // dpm($user, '$user');
    $content['cols-wrapper']['col-1']['heading'] = array(
      '#markup' => '<h3>Welcome back ' . $user->name . '</h3>',
      '#weight' => 1);
  }

  // dpm($content, '$content');
  return $content;
}



/**
 * Implements hook_form_FORM_ID_alter().
 */
function casa_core_form_user_register_form_alter(&$form, &$form_state, $form_id) {
  // dpm($form, 'form');
  // dpm($form_state, 'form_state');

  // Move the 'account' fields (username and email address) out of their fieldset.
  unset($form['#group_children']['account']);
}



/**
 * Implements hook_form_FORM_ID_alter().
 * Form used to edit *existing* users, not create new users.
 */
function casa_core_form_user_profile_form_alter(&$form, &$form_state, $form_id) {
  // dpm($form, 'form');
  // dpm($form_state, 'form_state');

  global $user; // The current user, not the user being edited.
  $is_admin = in_array('Administrator', $user->roles);
  // dpm($is_admin, '$is_admin');

  if(!$is_admin) {
    $form['field_reliability']['#access'] = FALSE;
  }
}



/**
 * Implements hook_admin_paths_alter().
 */
function casa_core_admin_paths_alter(&$paths) {
  //return FALSE to the path where you don't want to show in OVERLAY
  $paths['node/add/identification'] = FALSE;
}



function casa_core_js_alter(&$javascript) {
  // dpm($javascript, 'javascript');

  // Move all custom module JS files between 'JS_DEFAULT' and 'JS_THEME' groups.
  foreach ($javascript as $file => $parameters) {
    // dpm(substr($file, 0, 24), 'substr');
    if(substr($file, 0, 24) == 'sites/all/modules/custom') {
      $javascript[$file]['group'] = 50;
    }
  }
  // dpm($javascript, 'javascript');
}


// function casa_core_user_insert(&$edit, $account, $category) {
//   // dpm($edit, '$edit');
//   // dpm($account, '$account');
//   // dpm($category, '$category');
// }





/**
 * Packages and sends the result of a page callback to the browser as HTML.
 *
 * This is a Custom implimentation of drupal_deliver_html_page(), but specifically for AJAX use.
 */
function ajax_deliver_html($page_callback_result) {
  // Emit the correct charset HTTP header, but not if the page callback
  // result is NULL, since that likely indicates that it printed something
  // in which case, no further headers may be sent, and not if code running
  // for this page request has already set the content type header.
  if (isset($page_callback_result) && is_null(drupal_get_http_header('Content-Type'))) {
    drupal_add_http_header('Content-Type', 'text/html; charset=utf-8');
  }

  // Send appropriate HTTP-Header for browsers and search engines.
  global $language;
  drupal_add_http_header('Content-Language', $language->language);

  if (isset($page_callback_result)) {
    print render($page_callback_result);
  }
  else {
    watchdog('Error in ajax_deliver_html()', check_plain($_GET['q']), NULL, WATCHDOG_WARNING);
    throw new Exception("Something went wrong retriving the markup", 1);
  }
}
